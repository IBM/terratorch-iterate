experiment_name: geobench_vit_tiny
run_name: geobench_vit
defaults:
  trainer_args:
    precision: bf16-mixed
    max_epochs: 1
    strategy: ddp
    devices: -1
    num_nodes: 1
  terratorch_task:
    model_args:
      backbone_pretrained: True
      backbone: prithvi_eo_v1_100
      backbone_out_indices:
        - 2
        - 5
        - 8
        - 11
    model_factory: EncoderDecoderFactory
    optimizer: AdamW
    
tasks:
  # - name: chesapeake
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #       backbone_bands:
  #       - RED
  #       - GREEN
  #       - BLUE
  #       - NIR_NARROW
  #       num_classes: 7
  #   datamodule:
  #     class_path: terratorch.datamodules.MChesapeakeLandcoverNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR"
  # - name: cashew
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       num_classes: 7
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #       backbone_coords_encoding:
  #         - "time"
  #   datamodule:
  #     class_path: terratorch.datamodules.MBeninSmallHolderCashewsNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       use_metadata: True
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR_NARROW"
  #         - "SWIR_1"
  #         - "SWIR_2"
  # - name: neontree
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       num_classes: 2
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #   datamodule:
  #     class_path: terratorch.datamodules.MNeonTreeNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  # - name: nz_cattle
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #       num_classes: 2
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #       backbone_coords_encoding:
  #         - "time"
  #         - "location"
  #   datamodule:
  #     class_path: terratorch.datamodules.MNzCattleNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       use_metadata: True
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  # - name: pv4ger_seg
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #       num_classes: 2
  #       backbone_coords_encoding:
  #         - "location"
  #   datamodule:
  #     class_path: terratorch.datamodules.MPv4gerSegNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       use_metadata: True
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  # - name: sa_crop_type
  #   type: segmentation
  #   direction: max
  #   metric: val/Multiclass_Jaccard_Index
  #   early_stop_patience: 50
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       decoder: UperNetDecoder
  #       decoder_channels: 128
  #       decoder_scale_modules: true
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       num_classes: 10
  #   datamodule:
  #     class_path: terratorch.datamodules.m_SA_crop_type.MSACropTypeNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/segmentation_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR_NARROW"
  #         - "SWIR_1"
  #         - "SWIR_2"
  #  # class
  # - name: big_earth_net
  #   type: multilabel_classification
  #   direction: max
  #   terratorch_task:
  #     loss: balanced_bce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       num_classes: 43
  #       decoder: IdentityDecoder
  #       head_linear_after_pool: True
  #   datamodule:
  #     class_path: terratorch.datamodules.MBigEarthNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR_NARROW"
  #         - "SWIR_1"
  #         - "SWIR_2"
  #   optimization_except:
  #     - decoder_channels
  #     - head_dropout
  #   metric: val/Multilabel_F1_Score_micro
  #   early_stop_patience: 50
  # - name: brick_kiln
  #   type: classification
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       num_classes: 2
  #       decoder: IdentityDecoder
  #       head_linear_after_pool: True
  #   direction: max
  #   datamodule:
  #     class_path: terratorch.datamodules.MBrickKilnNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR_NARROW"
  #         - "SWIR_1"
  #         - "SWIR_2"
  #   optimization_except:
  #     - decoder_channels
  #     - head_dropout
  #   metric: val/Accuracy_Micro
  #   early_stop_patience: 50
  # - name: eurosat
  #   type: classification
  #   direction: max
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       num_classes: 10
  #       decoder: IdentityDecoder
  #       head_linear_after_pool: True
  #   datamodule:
  #     class_path: terratorch.datamodules.MEuroSATNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR_NARROW"
  #         - "SWIR_1"
  #         - "SWIR_2"
  #   optimization_except:
  #     - decoder_channels
  #     - head_dropout
  #   metric: val/Accuracy_Micro
  #   early_stop_patience: 50
  # - name: forestnet
  #   type: classification
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #         - NIR_NARROW
  #         - SWIR_1
  #         - SWIR_2
  #       num_classes: 17
  #       decoder: IdentityDecoder
  #       head_linear_after_pool: True
  #       backbone_coords_encoding:
  #         - "time"
  #         - "location"
  #   direction: max
  #   datamodule:
  #     class_path: terratorch.datamodules.MForestNetNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       use_metadata: True
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #         - "NIR"
  #         - "SWIR_1"
  #         - "SWIR_2"
  #   optimization_except:
  #     - decoder_channels
  #     - head_dropout
  #   metric: val/Accuracy_Micro
  #   early_stop_patience: 50
  # - name: pv4ger
  #   type: classification
  #   terratorch_task:
  #     loss: ce
  #     model_args:
  #       backbone_bands:
  #         - RED
  #         - GREEN
  #         - BLUE
  #       num_classes: 2
  #       decoder: IdentityDecoder
  #       head_linear_after_pool: True
  #       backbone_coords_encoding:
  #         - "location"
  #   direction: max
  #   datamodule:
  #     class_path: terratorch.datamodules.MPv4gerNonGeoDataModule
  #     init_args:
  #       partition: 1.00x_train
  #       use_metadata: True
  #       train_transform:
  #         - class_path: albumentations.HorizontalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomRotate90
  #         #   init_args:
  #         #     p: 0.5
  #         - class_path: albumentations.VerticalFlip
  #           init_args:
  #             p: 0.5
  #         # - class_path: albumentations.RandomBrightnessContrast
  #         #   init_args:
  #         #     p: 0.8
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       val_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       test_transform:
  #         - class_path: albumentations.Resize
  #           init_args:
  #             height: 224
  #             width: 224
  #         - class_path: ToTensorV2
  #       batch_size: 16
  #       num_workers: 6
  #       data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
  #       bands:
  #         - "RED"
  #         - "GREEN"
  #         - "BLUE"
  #   optimization_except:
  #     - decoder_channels
  #     - head_dropout
  #   metric: val/Accuracy_Micro
  #   early_stop_patience: 50
  - name: so2sat
    type: classification
    direction: max
    terratorch_task:
      loss: ce
      model_args:
        backbone_bands:
          - RED
          - GREEN
          - BLUE
          - NIR_NARROW
          - SWIR_1
          - SWIR_2
        num_classes: 17
        decoder: IdentityDecoder
        head_linear_after_pool: True
        peft_config:
          method: LORA
          replace_qkv: qkv
          peft_config_kwargs:
            target_modules:
            - qkv.q_linear
            - qkv.v_linear
            - mlp.fc1
            - mlp.fc2
            r: 8
            lora_alpha: 32
            lora_dropout: 0.1
    datamodule:
      class_path: terratorch.datamodules.MSo2SatNonGeoDataModule
      init_args:
        partition: 1.00x_train
        train_transform:
          - class_path: albumentations.HorizontalFlip
            init_args:
              p: 0.5
          # - class_path: albumentations.RandomRotate90
          #   init_args:
          #     p: 0.5
          - class_path: albumentations.VerticalFlip
            init_args:
              p: 0.5
          # - class_path: albumentations.RandomBrightnessContrast
          #   init_args:
          #     p: 0.8
          - class_path: albumentations.Resize
            init_args:
              height: 224
              width: 224
          - class_path: ToTensorV2
        val_transform:
          - class_path: albumentations.Resize
            init_args:
              height: 224
              width: 224
          - class_path: ToTensorV2
        test_transform:
          - class_path: albumentations.Resize
            init_args:
              height: 224
              width: 224
          - class_path: ToTensorV2
        batch_size: 16
        num_workers: 6
        data_root: "/dccstor/geofm-finetuning/datasets/geobench/classification_v1.0"
        bands:
          - "RED"
          - "GREEN"
          - "BLUE"
          - "NIR_NARROW"
          - "SWIR_1"
          - "SWIR_2"
    optimization_except:
      - decoder_channels
      - head_dropout
    metric: val/Accuracy_Micro
    early_stop_patience: 50

run_repetitions: 1
n_trials: 1
save_models: False
storage_uri: /dccstor/geofm-finetuning/terratorch-iterate-test/hpo
ray_storage_path: /dccstor/geofm-finetuning/terratorch-iterate-test/ray_storage
optimization_space:
  lr:
    max: 1e-3
    min: 1e-6
    type: real
    log: true
  optimizer_hparams:
    weight_decay:
      min: 0
      max: 0.4
      type: real
  model_args:
    decoder_channels:
      - 64
      - 128
      - 256